name: Deploy website on push

on:
  push:
    branches:
      - main  # Deploy when changes are pushed to the main branch

jobs:
  web-build:
    name: Build and Test
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Set up PHP with Xdebug
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, intl, bcmath, xdebug  # Install xdebug for coverage

    - name: Verify Xdebug Installation
      run: |
        php -m | grep xdebug  # Verify that Xdebug is installed

    - name: Install Composer globally
      run: curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

    - name: Install Composer dependencies
      run: |
        composer install --no-interaction --prefer-dist

    - name: Fix execute permissions for PHPUnit
      run: |
        chmod +x vendor/bin/phpunit  # Ensure the PHPunit binary is executable

    - name: Run PHPUnit Tests
      run: vendor/bin/phpunit --coverage-clover=coverage/clover.xml

    - name: Upload Coverage Report
      uses: actions/upload-artifact@v3
      with:
        name: coverage-report
        path: coverage/clover.xml
        
    # - name: Run PHPUnit tests with code coverage
    #   run: |
    #     vendor/bin/phpunit --configuration phpunit.xml.dist
      # vendor/bin/phpunit --configuration phpunit.xml --coverage-html coverage-report

    # - name: Upload code coverage report
    #   uses: actions/upload-artifact@v3
    #   with:
    #     name: coverage-report
    #     path: coverage-report/**  

  # web-deploy:
  #   name: Deploy
  #   needs: web-build
  #   runs-on: ubuntu-latest

  #   steps:
  #   - name: Get latest code
  #     uses: actions/checkout@v2

  #   - name: Sync files to server
  #     uses: SamKirkland/FTP-Deploy-Action@v4.3.5
  #     with:
  #       server: ${{ secrets.ftp_server }}
  #       username: ${{ secrets.ftp_username }}
  #       password: ${{ secrets.ftp_password }}
  #       server_dir: /public_html/demo_project_cicd/
  #       ftp_options: |
  #         --dry-run   # Run a dry-run to test without actually uploading anything.
  #         --verbose   # Log more detailed information for debugging.
